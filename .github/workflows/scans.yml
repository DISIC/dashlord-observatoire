name: DashLord scans

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Analyser une seule démarche ou scanner toutes les démarches"
        required: false
        default: ""
  schedule:
    - cron: "0 0 * * 0" # see https://crontab.guru
  push:
    branches:
      - master
      - main
    paths:
      - "dashlord.yaml"
      - "dashlord.yml"
      - "urls.txt"

# allow only one concurrent scan action
concurrency:
  cancel-in-progress: true
  group: scans

jobs:
  init:
    runs-on: ubuntu-latest
    name: Prepare
    outputs:
      sites: ${{ steps.init.outputs.sites }}
      config: ${{ steps.init.outputs.config }}
    steps:
      - uses: actions/checkout@v2
      - id: pre_init
        uses: "DISIC/dashlord-observatoire/actions/airtable-procedures-urls@main"
        with:
          airtable_api_key: ${{ secrets.AIRTABLE_API_KEY }}
          airtable_base_id: ${{ secrets.AIRTABLE_BASE_ID }}
          airtable_table_name: ${{ secrets.AIRTABLE_TABLE_NAME }}
          output: airtable-procedures_urls.json
      - id: init
        uses: "SocialGouv/dashlord-actions/init@main"
        with:
          url: https://recrutement.aefe.fr/residents/,https://www.usagers.antai.gouv.fr/demarches/saisienumero?lang=fr,https://www.teleaccords.travail-emploi.gouv.fr/PortailTeleprocedures/,https://www.monespace.justice.fr/authentification,https://wwwd.caf.fr/wps/portal/caffr/aidesetservices/lesservicesenligne/faireunedemandedeprestation/demanderlaideaulogement,https://www.amendes.gouv.fr/,https://www.douane.gouv.fr/service-en-ligne/ouverture?code_teleservice=RITA_ENCYCLOPEDIE&sid=&app=38,https://connect.caf.fr/connexionappli/dist/?forceReload=20211220&contexteAppel=caffr&urlredirect=%2Fwps%2Fmyportal%2Fcaffr%2Fmoncompte%2Ftableaudebord#/login,https://foret.agriculture.gouv.fr/teleprocedures-foret/coupe/accueilCoupe.xhtml,https://www.parcoursup.fr/,https://teleservices.education.gouv.fr/,https://presaje.sga.defense.gouv.fr/,https://france-visas.gouv.fr/fr_FR/web/france-visas,https://data.inpi.fr/,https://www.service-public.fr/particuliers/vosdroits/R42839,https://www.marches-publics.gouv.fr/,https://candidat.pole-emploi.fr/offres/emploi,https://www.douane.gouv.fr/service-en-ligne/declaration-de-transit-douanier-delta-t,https://www.douane.gouv.fr/service-en-ligne/ouverture?code_teleservice=DEB_SUR_PRO_DOUANE&sid=&app=53,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_declarer_naissance_page,https://teleservices.education.gouv.fr/,https://www.pre-plainte-en-ligne.gouv.fr/,https://www.servicehistorique.sga.defense.gouv.fr/demarche/reporter-ou-annuler-une-seance-de-travail,https://www.registrenationaldesrefus.fr/,https://dse.phm.education.gouv.fr/GEN/,https://formulaire.defenseurdesdroits.fr/code/afficher.php?ETAPE=accueil_2016,https://www.certificat-air.gouv.fr/,https://teleservices.education.gouv.fr/,https://www.demarches-plaisance.gouv.fr/puma-plaisancier/plaisancier/mes-paiements,https://www.service-public.fr/particuliers/vosdroits/R43248,https://candidat.pole-emploi.fr/formations/recherche,https://www.penitentiaire.justice.fr/authentification?returnUrl=%2F,https://www.onac-vg.fr/demarches/demander-une-aide-financiere,https://diplome.gouv.fr/,https://www.impots.gouv.fr/,https://demande-autonomie.gouv.fr/api/dua/utilisateurFC/authentification/?service=DUAPA&portail=0018&modeOuverture=onglet,https://entreprise.pole-emploi.fr/accueil/,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_carte_euro_assu_maladie_page,https://www.impots.gouv.fr/,https://rieau.cohesion-territoires.gouv.fr/,https://www.mesdroitssociaux.gouv.fr/,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_attestation_paiement_ij_page,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_commande_vitale_page,https://immatriculation.ants.gouv.fr/,https://www.justice.fr/notice/idtdb001-requ%C3%AAte-juge-affaires-familiales,https://meae-tour3.votezaletranger.gouv.fr/,https://www.messervices.etudiant.gouv.fr/depotPVE//?idEtudiantPVE=3110718,https://www.monespace.justice.fr/authentification,https://data.inpi.fr/,https://teleservices.education.gouv.fr/,https://immatriculation.ants.gouv.fr/,https://immatriculation.ants.gouv.fr/,https://france-visas.gouv.fr/fr_FR/web/france-visas,https://www.service-public.fr/professionnels-entreprises/vosdroits/R42920,https://www.lassuranceretraite.fr/portail-services-ihm/index.html#/sec/afficherIframe/CONSULT_MONTANT,https://teleservices.education.gouv.fr/,https://www.pajemploi.urssaf.fr/pajeweb/activation.htm,https://www.info-retraite.fr/portail-services/drl,https://www.impots.gouv.fr/portail/,https://permisdeconduire.ants.gouv.fr/,https://permisdeconduire.ants.gouv.fr/,https://www.moncompteformation.gouv.fr/espace-prive/html/#/utilisateur/inscription,https://alphatango.aviation-civile.gouv.fr/#notification/{exp_id}/new,https://wwwd.caf.fr/wps/portal/caffr/aidesetservices/lesservicesenligne/faireunedemandedeprestation/demanderlaprimedactivite/,https://www.service-public.fr/particuliers/vosdroits/N359,https://mesdemarches.culture.gouv.fr/,https://permisdeconduire.ants.gouv.fr/,https://index-egapro.travail.gouv.fr/,https://account.guichet-entreprises.fr/session/new,https://votefae.diplomatie.gouv.fr/pages/vote-clos.htm,https://www.maprimerenov.gouv.fr/,https://www.cesu.urssaf.fr/decla/index.html?page=page_adhesion_futur_employeur&LANG=FR,https://www.service-public.fr/particuliers/vosdroits/R46526,https://teleservices.education.gouv.fr/,https://www.service-public.fr/particuliers/vosdroits/R46121,https://www.info-retraite.fr/portail-services/#/drv,https://www.service-public.fr/particuliers/vosdroits/R47955,https://www.cfe.urssaf.fr/saisiepl/,https://www.justice.fr/notice/idtdb170-se-constituer-partie-civile-vous-%C3%AAtes-qualifi%C3%A9e-victime-proc%C3%A9dure-vous-avez-re%C3%A7u-avis-tribunal,https://wwwd.caf.fr/wps/portal/caffr/login/#/signature,https://passeport.ants.gouv.fr/Services-associes/Realiser-une-pre-demande-de-carte-nationale-d-identite-CNI,https://passeport.ants.gouv.fr/Services-associes/Realiser-une-pre-demande-de-passeport,https://www.primealaconversion.gouv.fr/dboneco/accueil/access.html,https://histovec.interieur.gouv.fr/histovec/home,https://pass.culture.fr/,https://teleservices.education.gouv.fr/,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_demander_cmuc_page,https://teleservices.education.gouv.fr/,https://teleservices.education.gouv.fr/,https://www.dmp.fr/patient/acces-web/login,https://activitepartielle.emploi.gouv.fr/aparts/,https://www.pajemploi.urssaf.fr/pajeweb/atfirecap.htm,https://chorus-pro.gouv.fr/cpp/utilisateur?execution=e1s1,https://timbres.impots.gouv.fr/,https://diplome.gouv.fr/,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_accueil_page&_somtc=true,https://www.place-emploi-public.gouv.fr/,https://www.lassuranceretraite.fr/portail-services-ihm/index.html#/sec/ouvrirService/AGEDEPART,https://www.douane.gouv.fr/service-en-ligne/ouverture?code_teleservice=DES&sid=&app=68,https://pastel.diplomatie.gouv.fr/fildariane/dyn/public/login.html,https://www.aidejuridictionnelle.justice.fr/,https://sic.certdc.inserm.fr/,https://wwwd.caf.fr/,https://entreprise.pole-emploi.fr/accueil/description/publier-offre,https://portailweb.franceagrimer.fr/portail/,https://www.inscriptionelectorale.service-public.fr/,https://administration-etrangers-en-france.interieur.gouv.fr/,https://pastel.diplomatie.gouv.fr/transparenceext/transparence_emplois_reseau_etranger.php,https://associations-depot-comptes.journal-officiel.gouv.fr/depotdescomptes/index.html,https://presaje.sga.defense.gouv.fr/,https://www.msa.fr/lfy,https://sia.registres.interieur.gouv.fr/,https://spls.application.logement.gouv.fr,https://teleservices.education.gouv.fr/,https://permisdeconduire.ants.gouv.fr/,https://alphatango.aviation-civile.gouv.fr/#aeronef/new,https://agriculture-portail.6tzen.fr/default/requests/Cerfa13995/,https://mes-aides.1jeune1solution.beta.gouv.fr/,https://teleservices.education.gouv.fr/,https://www2.telepac.agriculture.gouv.fr/telepac/auth/accueil.action,https://sylae.asp-public.fr/sylae/,https://lecompteasso.associations.gouv.fr/client/login,https://sia.registres.interieur.gouv.fr/,https://teleservices.education.gouv.fr/,https://attestation-vaccin.ameli.fr/,https://www.douane.gouv.fr/service-en-ligne/declaration-fiscale-sur-les-vins-et-alcools-ciel,https://preinsc.archi.fr/taiga/cnd/index.php,https://www.cesu.urssaf.fr/decla/index.html?page=page_declaration&LANG=FR,https://portail.chorus-pro.gouv.fr/,https://www.service-public.fr/particuliers/vosdroits/R2054,https://permisdeconduire.ants.gouv.fr/,https://www.service-public.fr/particuliers/vosdroits/R52221,https://www.pajemploi.urssaf.fr/pajeweb/decla/identification/listeSalaries.htm,https://www2.telepac.agriculture.gouv.fr/telepac/auth/accueil.action,https://www.cesu.urssaf.fr/decla/index.html?page=page_empl_avantage_fiscal&LANG=FR ,https://www.service-public.fr/professionnels-entreprises/vosdroits/R31441,https://www.onac-vg.fr/user/login?destination=/form/form-trn-cc%3Fsource_entity_type%3Dnode%26amp%253Bsource_entity_id%3D11,https://www.demarches-simplifiees.fr/commencer/neph75,https://www.service-public.fr/particuliers/vosdroits/R11193,https://cites.application.developpement-durable.gouv.fr/,https://maprocuration.gouv.fr/,https://agriculture-portail.6tzen.fr/default/requests/Cerfa13984/,https://data.inpi.fr/,https://www.justice.fr/notice/idtdb001-requ%C3%AAte-juge-affaires-familiales,https://www.cned.fr/compte,https://www.msa.fr/lfy,https://www.servicehistorique.sga.defense.gouv.fr/demarche/reserver-un-document-en-salle,https://wwwd.caf.fr/wps/portal/caffr/login/!ut/p/a1/04_Sj9CPykssy0xPLMnMz0vMAfGjzOID_A3dPbyDDdz9A1yNDTxdzQNDXJ19DS0CjYAKIoEKDHAARwNC-sP1o8BK8JhQkBthkO6oqAgArtbX2Q!!/dl5/d5/L2dBISEvZ0FBIS9nQSEh/#/signature,https://ecoagri.agriculture.gouv.fr/logics-usager/,https://www.autoentrepreneur.urssaf.fr/portail/accueil/creer-mon-auto-entreprise.html,https://casier-judiciaire.justice.gouv.fr/mai-web-b3-presentation/pages/creation/orientation.xhtml?cid=1,https://wwwd.caf.fr/wps/portal/caffr/aidesetservices/lesservicesenligne/faireunedemandedeprestation/demanderlaideaulogement,https://candidat.pole-emploi.fr/offres/emploi,https://www.servicehistorique.sga.defense.gouv.fr/demarche/etre-oriente,https://www.demarches-plaisance.gouv.fr/puma-plaisancier/,https://www.autoentrepreneur.urssaf.fr/portail/accueil.html,https://teleservices.education.gouv.fr/,https://permisdeconduire.ants.gouv.fr/,https://siv.interieur.gouv.fr/map-usg-ui/do/accueil_certificat,https://www.monespace.justice.fr/authentification,https://www.dossierfacile.fr/,https://www.demande-logement-social.gouv.fr/,https://wwwd.caf.fr/,https://www.douane.gouv.fr/service-en-ligne/gestion-de-bordereaux-de-vente-en-detaxe-pablo-i,https://www.douane.gouv.fr/service-en-ligne/mouvements-de-produits-soumis-accise-emcs-gamma,https://assure.ameli.fr/PortailAS/appmanager/PortailAS/assure?_nfpb=true&_pageLabel=as_mod_adresse_postale_page,https://tele7.interieur.gouv.fr/tlp/,https://www.due.urssaf.fr/declarant/index.jsf,https://candidat.pole-emploi.fr/inscription-en-ligne/accueil,https://partenaires.caf.fr/portal/auth/login,https://www.service-public.fr/particuliers/vosdroits/R47816,https://www.msa.fr/lfy,https://mdphenligne.cnsa.fr/,https://www2.telepac.agriculture.gouv.fr/telepac/auth/accueil.action,https://wwwd.caf.fr/wps/portal/caffr/aidesetservices/lesservicesenligne/faireunedemandedeprestation#/solidariteetactivite,https://wwwd.caf.fr/wps/portal/caffr/login/!ut/p/a1/04_Sj9CPykssy0xPLMnMz0vMAfGjzOID_A3dPbyDDdz9A1yNDTxdzQNDXJ19DS0CjYAKIoEKDHAARwNC-sP1o8BK8JhQkBthkO6oqAgArtbX2Q!!/dl5/d5/L2dBISEvZ0FBIS9nQSEh/#/signature,https://presaje.sga.defense.gouv.fr/,https://presaje.sga.defense.gouv.fr/,https://www.lassuranceretraite.fr/portail-services-ihm/index.html#/authentifier,http://www.securite-routiere.gouv.fr/permis-de-conduire/resultats-du-permis-de-conduire#/step-connexion,https://www.douane.gouv.fr/service-en-ligne/declaration-en-douane-fret-traditionnel-delta-g,https://www.service-public.fr/compte/se-connecter?targetUrl=/loginSuccessFromSp&typeCompte=association, https://mon-entreprise.urssaf.fr/simulateurs/salaire-brut-net,https://www.telepaiement.dgfip.finances.gouv.fr/stl/satelit.web,https://designations.cnil.fr/dpo/,https://teleservices.education.gouv.fr/,https://mesdemarches.culture.gouv.fr/loc_fr/mcc/requests/THEAT_LICEN_declaration_00,https://teleservices.education.gouv.fr/,https://www.cnil.fr/fr/plaintes/,https://www.urssaf.fr/portail/home/creer-votre-espace.html,https://www.trouvermonmaster.gouv.fr/,https://www.televideoprotection.interieur.gouv.fr/gup/PhpVideo/TeleDeclaration/cnxAccueil.php,https://www.msa.fr/lfy,https://data.inpi.fr/,https://www.le-recensement-et-moi.fr/rpetmoi/accueil,https://immatriculation.ants.gouv.fr/,https://www.service-public.fr/particuliers/vosdroits/R1405,https://trouverunlogement.lescrous.fr,https://www.sipsi.travail.gouv.fr/SipsiCasFo/login?service=https%3A%2F%2Fwww.sipsi.travail.gouv.fr%2FSipsiFO,https://activitepartielle.emploi.gouv.fr/aparts/ ,https://lajusticerecrute.fr/,https://cvec.etudiant.gouv.fr/,https://monprojet.anah.gouv.fr/,https://www.servicehistorique.sga.defense.gouv.fr/demarche/demande-de-documents-administratifs,https://immatriculation.ants.gouv.fr/,https://www.antai.gouv.fr/dossier-infraction?lang=fr,https://www.demande-logement-social.gouv.fr/,https://www.info-retraite.fr/portail-services/#/login#header,https://www.cadastre.gouv.fr/,https://www.impots.gouv.fr/,https://actualisationenrichie.pole-emploi.fr,https://pastel.diplomatie.gouv.fr/etudesenfrance/dyn/public/authentification/login.html,https://teleservices.education.gouv.fr/,https://www.telerc.travail.gouv.fr/,https://monaiot.developpement-durable.gouv.fr/page/nouvelles-modalites-connexion,https://citoyens.telerecours.fr/

  scans:
    runs-on: ubuntu-latest
    name: Scan
    needs: init
    continue-on-error: true
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        sites: ${{ fromJson(needs.init.outputs.sites) }}
    steps:
      - uses: actions/checkout@v2

      - run: |
          mkdir scans

      - uses: actions/cache@v2
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Déclaration a11y
        continue-on-error: true
        uses: "socialgouv/dashlord-actions/declaration-a11y@v1"
        if: ${{ matrix.sites.tools['declaration-a11y'] }}
        with:
          url: ${{ matrix.sites.url }}
          output: scans/declaration-a11y.json

      - name: eco-index
        continue-on-error: true
        uses: "socialgouv/dashlord-actions/ecoindex@v1"
        if: ${{ matrix.sites.tools.ecoindex }}
        with:
          url: ${{ matrix.sites.url }}
          output: scans/ecoindex.json

      - name: Lighthouse scan
        continue-on-error: true
        timeout-minutes: 10
        uses: SocialGouv/dashlord-actions/lhci@v1
        if: ${{ matrix.sites.tools.lighthouse }}
        with:
          url: "${{ join(matrix.sites.subpages, ',') }}"

      - name: Updown.io checks
        continue-on-error: true
        timeout-minutes: 10
        uses: "MTES-MCT/updownio-action@main"
        if: ${{ matrix.sites.tools.updownio }}
        with:
          apiKey: ${{ secrets.UPDOWNIO_API_KEY }}
          url: ${{ matrix.sites.url }}
          output: scans/updownio.json

      - uses: SocialGouv/dashlord-actions/save@main
        with:
          url: ${{ matrix.sites.url }}

      - uses: EndBug/add-and-commit@v7
        with:
          add: '["results"]'
          author_name: ${{ secrets.SOCIALGROOVYBOT_NAME }}
          author_email: ${{ secrets.SOCIALGROOVYBOT_EMAIL }}
          message: "update: ${{ matrix.sites.url }}"
